<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ezlive - P2P í™”ìƒ ë° íŒŒì¼ ê³µìœ </title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- PeerJS CDN -->
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        /* Custom styles for video elements */
        .video-container {
            width: 100%;
            height: 400px;
            display: flex;
            gap: 1rem;
        }
        video {
            width: 50%;
            height: 100%;
            object-fit: cover;
            background-color: #1f2937; /* dark gray background */
        }
        /* Mobile adjustments */
        @media (max-width: 768px) {
            .video-container {
                flex-direction: column;
                height: auto;
            }
            video {
                width: 100%;
                height: 200px;
            }
        }
        /* Style for progress bar (optional, Tailwind doesn't style native progress well) */
        progress {
            /* Tailwind equivalent styles for a visible progress bar */
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            border: none;
            border-radius: 9999px; /* rounded-full */
            height: 8px; /* h-2 */
        }
        progress::-webkit-progress-bar {
            background-color: #e5e7eb; /* bg-gray-200 */
            border-radius: 9999px;
        }
        progress::-webkit-progress-value {
            background-color: #3b82f6; /* bg-blue-500 */
            border-radius: 9999px;
        }
        progress::-moz-progress-bar {
            background-color: #3b82f6;
            border-radius: 9999px;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4 md:p-8 font-sans">

    <!-- Main Container -->
    <div id="app" class="max-w-4xl mx-auto bg-white shadow-xl rounded-xl p-6 md:p-10">
        <h1 class="text-3xl md:text-4xl font-extrabold text-blue-600 mb-6 text-center">
            ezlive P2P í™”ìƒ ë° íŒŒì¼ ê³µìœ 
        </h1>

        <!-- Status Message Box -->
        <div id="status-box" class="p-3 mb-6 rounded-lg text-sm transition-all duration-300 hidden"></div>

        <!-- Dynamic Content Area -->
        <div id="content">
            <!-- Content will be rendered here by JavaScript -->
        </div>

        <!-- Modal for Custom Messages (instead of alert) -->
        <div id="modal-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-50 hidden items-center justify-center">
            <div class="bg-white p-6 rounded-lg shadow-2xl max-w-sm w-full">
                <h3 id="modal-title" class="text-xl font-bold mb-3 text-red-600">ì˜¤ë¥˜</h3>
                <p id="modal-message" class="text-gray-700 mb-6">ë©”ì‹œì§€ ë‚´ìš©</p>
                <button onclick="hideModal()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 rounded-lg transition duration-150">í™•ì¸</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK Imports (Required for environment, though not used for P2P logic) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables provided by the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, db, auth;

        async function initFirebase() {
            try {
                if (Object.keys(firebaseConfig).length > 0) {
                    setLogLevel('debug');
                    app = initializeApp(firebaseConfig);
                    auth = getAuth(app);
                    db = getFirestore(app);

                    // Authenticate
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                        console.log("Firebase: Signed in with custom token.");
                    } else {
                        await signInAnonymously(auth);
                        console.log("Firebase: Signed in anonymously.");
                    }

                    // Set global userId after auth
                    window.currentUserId = auth.currentUser?.uid || 'anonymous';
                    console.log("Current User ID:", window.currentUserId);
                } else {
                    console.warn("Firebase: Config not found. Proceeding without Firebase services.");
                }
            } catch (error) {
                console.error("Firebase Initialization Error:", error);
            }
        }

        initFirebase();
    </script>

    <script>
        // --- Global State and PeerJS Setup ---
        let currentView = 'start'; // 'start', 'host_display', 'client_connect', 'chat'
        let peer = null;
        let myId = null;
        let remoteId = null;

        // Media Stream State
        let myStream = null;
        let remoteStream = null;
        let isVideoEnabled = true;
        let isAudioEnabled = true;

        // Data Channel State (for file sharing)
        let dataConnection = null;
        const CHUNK_SIZE = 16 * 1024; // 16KB chunk size for DataChannel
        let receivingFile = {}; // State for file currently being received

        let peerConfig = {
            // Using the default PeerJS cloud server
            host: '0.peerjs.com',
            port: 443,
            secure: true
        };

        const contentDiv = document.getElementById('content');
        const statusBox = document.getElementById('status-box');
        const modalOverlay = document.getElementById('modal-overlay');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');

        // --- Utility Functions ---

        function showModal(title, message, isError = true) {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            modalTitle.className = isError ? 'text-xl font-bold mb-3 text-red-600' : 'text-xl font-bold mb-3 text-green-600';
            modalOverlay.classList.remove('hidden');
            modalOverlay.classList.add('flex');
        }

        function hideModal() {
            modalOverlay.classList.add('hidden');
            modalOverlay.classList.remove('flex');
        }

        function updateStatus(message, type = 'info') {
            statusBox.textContent = message;
            statusBox.classList.remove('hidden', 'bg-red-100', 'text-red-700', 'bg-green-100', 'text-green-700', 'bg-yellow-100', 'text-yellow-700', 'bg-blue-100', 'text-blue-700');
            statusBox.classList.add('p-3', 'mb-6', 'text-sm');

            if (type === 'error') {
                statusBox.classList.add('bg-red-100', 'text-red-700');
            } else if (type === 'success') {
                statusBox.classList.add('bg-green-100', 'text-green-700');
            } else if (type === 'warning') {
                statusBox.classList.add('bg-yellow-100', 'text-yellow-700');
            } else {
                statusBox.classList.add('bg-blue-100', 'text-blue-700');
            }
        }

        function render() {
            contentDiv.innerHTML = '';
            updateStatus("--- ìƒíƒœ ëŒ€ê¸° ì¤‘ ---", 'info');

            if (currentView === 'start') {
                renderStartView();
            } else if (currentView === 'host_display') {
                renderHostDisplayView();
            } else if (currentView === 'client_connect') {
                renderClientConnectView();
            } else if (currentView === 'chat') {
                renderChatView();
            }
        }

        // --- Media Control Functions ---
        function toggleVideo() {
            if (!myStream) return;
            isVideoEnabled = !isVideoEnabled;
            myStream.getVideoTracks().forEach(track => track.enabled = isVideoEnabled);
            
            const btn = document.getElementById('toggle-video-btn');
            btn.innerHTML = isVideoEnabled 
                ? '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-video"><path d="m22 8-6 4 6 4V8Z"/><path d="M14 5H4a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2Z"/></svg>'
                : '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-video-off"><path d="M10.36 12.86L2.94 5.44M2 12v3a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-3a2 2 0 0 0-2-2h-3.14M22 7l-5.46 3.42a1 1 0 0 1-1.12-.13l-4.22-3.37L10.36 12.86M2 2l20 20"/></svg>';

            btn.title = isVideoEnabled ? 'ë¹„ë””ì˜¤ ë„ê¸°' : 'ë¹„ë””ì˜¤ ì¼œê¸°';
            btn.classList.toggle('bg-red-500', !isVideoEnabled);
            btn.classList.toggle('bg-green-500', isVideoEnabled);

            updateStatus(isVideoEnabled ? "ë¹„ë””ì˜¤ê°€ ì¼œì¡ŒìŠµë‹ˆë‹¤." : "ë¹„ë””ì˜¤ê°€ êº¼ì¡ŒìŠµë‹ˆë‹¤.", isVideoEnabled ? 'success' : 'info');
        }

        function toggleAudio() {
            if (!myStream) return;
            isAudioEnabled = !isAudioEnabled;
            myStream.getAudioTracks().forEach(track => track.enabled = isAudioEnabled);

            const btn = document.getElementById('toggle-audio-btn');
            btn.innerHTML = isAudioEnabled
                ? '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-mic"><path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" x2="12" y1="19" y2="22"/></svg>'
                : '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-mic-off"><line x1="2" x2="22" y1="2" y2="22"></line><path d="M19 5v4"></path><path d="M22 10a10 10 0 0 1-8.5 9.87"></path><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><path d="M9 10v2a3 3 0 0 0 6 0v-2"></path><line x1="5" x2="5" y1="10" y2="15"></line><line x1="19" x2="19" y1="18" y2="15"></line></svg>';
            
            btn.title = isAudioEnabled ? 'ë§ˆì´í¬ ë„ê¸°' : 'ë§ˆì´í¬ ì¼œê¸°';
            btn.classList.toggle('bg-red-500', !isAudioEnabled);
            btn.classList.toggle('bg-green-500', isAudioEnabled);

            updateStatus(isAudioEnabled ? "ë§ˆì´í¬ê°€ ì¼œì¡ŒìŠµë‹ˆë‹¤." : "ë§ˆì´í¬ê°€ êº¼ì¡ŒìŠµë‹ˆë‹¤.", isAudioEnabled ? 'success' : 'info');
        }


        // --- File Transfer Functions ---
        function sendFile() {
            const fileInput = document.getElementById('file-input');
            const file = fileInput.files[0];
            const statusText = document.getElementById('file-transfer-status');

            if (!file || !dataConnection || !dataConnection.open) {
                updateStatus("íŒŒì¼ì„ ì„ íƒí•˜ê±°ë‚˜ ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.", 'error');
                return;
            }

            // Enforce 100MB limit (100 * 1024 * 1024 bytes)
            if (file.size > 100 * 1048576) {
                showModal("ìš©ëŸ‰ ì´ˆê³¼", `íŒŒì¼ì€ ìµœëŒ€ 100MBê¹Œì§€ë§Œ ì „ì†¡í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. (í˜„ì¬ ${Math.ceil(file.size / 1048576)}MB)`, true);
                return;
            }

            const totalChunks = Math.ceil(file.size / CHUNK_SIZE);
            let offset = 0;

            // 1. Send file metadata (JSON string)
            const metadata = {
                fileName: file.name,
                fileSize: file.size,
                fileType: file.type,
                totalChunks: totalChunks,
                type: 'file-meta'
            };
            dataConnection.send(JSON.stringify(metadata));

            statusText.textContent = `[${file.name}] ì „ì†¡ ì‹œì‘... (0%)`;
            statusText.classList.remove('hidden');
            document.getElementById('send-file-btn').disabled = true;
            fileInput.disabled = true;

            // 2. Start sending chunks (ArrayBuffer)
            function sendNextChunk() {
                // Ensure data channel is ready before sending
                if (dataConnection.bufferedAmount > 1024 * 1024 * 10) { // Limit buffer to prevent memory issues
                    setTimeout(sendNextChunk, 50);
                    return;
                }

                const end = Math.min(offset + CHUNK_SIZE, file.size);
                const chunk = file.slice(offset, end);

                dataConnection.send(chunk);

                offset = end;
                const percent = Math.round((offset / file.size) * 100);
                statusText.textContent = `[${file.name}] ì „ì†¡ ì¤‘... (${percent}%)`;

                if (offset < file.size) {
                    // Use setTimeout to yield execution and prevent freezing the UI
                    setTimeout(sendNextChunk, 10);
                } else {
                    // 3. Send transfer complete signal
                    dataConnection.send(JSON.stringify({ type: 'file-end', fileName: file.name }));
                    statusText.textContent = `[${file.name}] ì „ì†¡ ì™„ë£Œ!`;
                    updateStatus("íŒŒì¼ ì „ì†¡ ì™„ë£Œ!", 'success');
                    document.getElementById('send-file-btn').disabled = false;
                    fileInput.disabled = false;
                    fileInput.value = ''; // Clear file input
                }
            }

            sendNextChunk();
        }

        function setupDataConnectionEvents(conn) {
            dataConnection = conn;
            dataConnection.on('open', () => {
                updateStatus("ë°ì´í„° ì±„ë„ ì—°ê²° ì„±ê³µ. íŒŒì¼ ê³µìœ ê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤.", 'success');
                // Re-enable file input button if a file is already selected
                if (currentView === 'chat') {
                    const fileInput = document.getElementById('file-input');
                    const sendBtn = document.getElementById('send-file-btn');
                    if (fileInput && fileInput.files.length > 0) {
                         sendBtn.disabled = false;
                    }
                }
            });

            dataConnection.on('data', (data) => {
                if (typeof data === 'string') {
                    try {
                        const message = JSON.parse(data);
                        if (message.type === 'file-meta') {
                            // Start receiving a new file
                            receivingFile = {
                                name: message.fileName,
                                size: message.fileSize,
                                type: message.fileType,
                                chunks: [],
                                receivedSize: 0,
                                totalChunks: message.totalChunks
                            };
                            document.getElementById('file-receive-area').classList.remove('hidden');
                            document.getElementById('receive-status').innerHTML = `
                                <strong>${receivingFile.name}</strong> ìˆ˜ì‹  ì‹œì‘... (0MB / ${(receivingFile.size / 1048576).toFixed(2)}MB)
                                <progress id="receive-progress" value="0" max="${receivingFile.size}"></progress>
                            `;
                            updateStatus(`[${receivingFile.name}] íŒŒì¼ ìˆ˜ì‹  ì‹œì‘.`, 'warning');

                        } else if (message.type === 'file-end') {
                            // File transfer complete, assemble and download
                            const totalBytes = new Blob(receivingFile.chunks, { type: receivingFile.type });
                            const fileUrl = URL.createObjectURL(totalBytes);
                            const link = document.createElement('a');
                            link.href = fileUrl;
                            link.download = receivingFile.name;
                            link.textContent = `[ë‹¤ìš´ë¡œë“œ] ${receivingFile.name} (${(totalBytes.size / 1048576).toFixed(2)}MB)`;
                            link.className = 'block mt-2 text-blue-600 hover:text-blue-800 underline break-all font-semibold';

                            document.getElementById('receive-status').innerHTML = ''; // Clear status
                            document.getElementById('receive-status').appendChild(link);
                            updateStatus(`[${receivingFile.name}] íŒŒì¼ ìˆ˜ì‹  ì™„ë£Œ! ë‹¤ìš´ë¡œë“œí•˜ì„¸ìš”.`, 'success');

                            // Clean up
                            receivingFile = {};
                        }
                    } catch (e) {
                        console.warn("Received non-file JSON string or failed parsing:", data);
                    }
                } else if (data instanceof ArrayBuffer && receivingFile.name) {
                    // Receive file chunk
                    receivingFile.chunks.push(data);
                    receivingFile.receivedSize += data.byteLength;

                    const percent = Math.round((receivingFile.receivedSize / receivingFile.size) * 100);
                    const receivedMB = (receivingFile.receivedSize / 1048576).toFixed(2);
                    const totalMB = (receivingFile.size / 1048576).toFixed(2);

                    document.getElementById('receive-status').innerHTML = `
                        <strong>${receivingFile.name}</strong> ìˆ˜ì‹  ì¤‘... (${receivedMB}MB / ${totalMB}MB) (${percent}%)
                        <progress id="receive-progress" value="${receivingFile.receivedSize}" max="${receivingFile.size}"></progress>
                    `;
                    document.getElementById('receive-progress').value = receivingFile.receivedSize;
                }
            });

            dataConnection.on('close', () => {
                updateStatus("ë°ì´í„° ì±„ë„ì´ ë‹«í˜”ìŠµë‹ˆë‹¤.", 'warning');
                dataConnection = null;
            });

            dataConnection.on('error', (err) => {
                console.error("DataConnection Error:", err);
                showModal("ë°ì´í„° ì±„ë„ ì˜¤ë¥˜", "íŒŒì¼ ì „ì†¡ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: " + err.message, true);
            });
        }
        
        // --- View Renderers ---

        function renderStartView() {
            contentDiv.innerHTML = `
                <div class="space-y-6 text-center">
                    <p class="text-gray-700 text-lg">P2P í™”ìƒ ì±„íŒ…ì„ ì‹œì‘í•˜ëŠ” ë°©ë²•ì„ ì„ íƒí•˜ì„¸ìš”.</p>

                    <!-- Host Button (Step 1: ë‚´ ì„œë²„ë¥¼ ë§Œë“¤ê³ ) -->
                    <button onclick="startHostFlow()"
                        class="w-full md:w-2/3 mx-auto bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-lg shadow-md transition duration-150 transform hover:scale-105">
                        <span class="text-xl">HOST (ë°© ë§Œë“¤ê¸°)</span>
                        <span class="block text-sm font-normal mt-1">ê³ ìœ  IDë¥¼ ìƒì„±í•˜ê³  ì—°ê²°ì„ ê¸°ë‹¤ë¦½ë‹ˆë‹¤.</span>
                    </button>

                    <div class="flex items-center justify-center space-x-4">
                        <hr class="flex-grow border-gray-300">
                        <span class="text-gray-500">ë˜ëŠ”</span>
                        <hr class="flex-grow border-gray-300">
                    </div>

                    <!-- Client Button (Step 3: ì†Œí†µ ì‹œì‘ ì¤€ë¹„) -->
                    <button onclick="setCurrentView('client_connect')"
                        class="w-full md:w-2/3 mx-auto bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg shadow-md transition duration-150 transform hover:scale-105">
                        <span class="text-xl">CLIENT (ë°© ì°¸ê°€í•˜ê¸°)</span>
                        <span class="block text-sm font-normal mt-1">Host IDë¥¼ ì…ë ¥í•˜ê³  ì—°ê²°í•©ë‹ˆë‹¤.</span>
                    </button>

                </div>
            `;
        }

        function renderHostDisplayView() {
            if (!myId) {
                updateStatus("Host IDê°€ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œì‘í•´ì£¼ì„¸ìš”.", 'error');
                return;
            }

            // Step 2: ì„œë²„ì˜ ì£¼ì†Œë¥¼ ê³µìœ í•´ì£¼ë©´
            contentDiv.innerHTML = `
                <div class="text-center space-y-6">
                    <h2 class="text-2xl font-bold text-gray-800">1ë‹¨ê³„: ì„œë²„(Host) ìƒì„± ì™„ë£Œ!</h2>
                    <p class="text-lg text-gray-700">ì´ IDë¥¼ ìƒëŒ€ë°©ì—ê²Œ ê³µìœ í•´ì£¼ì„¸ìš”:</p>

                    <div class="bg-gray-200 p-4 rounded-lg shadow-inner flex justify-between items-center">
                        <span id="host-id-display" class="text-2xl md:text-3xl font-mono text-gray-800 break-all">${myId}</span>
                        <button onclick="copyId('${myId}')" class="bg-blue-500 hover:bg-blue-600 text-white text-sm font-semibold py-2 px-4 rounded-lg ml-4 transition duration-150">
                            ë³µì‚¬
                        </button>
                    </div>

                    <p class="text-yellow-600 font-semibold mt-6">
                        ìƒëŒ€ë°©ì˜ ì—°ê²°ì„ ê¸°ë‹¤ë¦¬ê³  ìˆìŠµë‹ˆë‹¤...
                    </p>

                    <div id="video-previews" class="video-container mt-8 rounded-lg overflow-hidden shadow-lg">
                        <video id="local-video" autoplay muted playsinline class="rounded-lg shadow-inner" poster="https://placehold.co/600x400/374151/ffffff?text=ë‚´+ì›¹ìº +ì¤€ë¹„+ì¤‘"></video>
                        <video id="remote-video" playsinline class="rounded-lg shadow-inner" poster="https://placehold.co/600x400/374151/ffffff?text=ìƒëŒ€ë°©+ì—°ê²°+ëŒ€ê¸°+ì¤‘"></video>
                    </div>

                    <button onclick="resetApp()" class="mt-8 text-sm text-red-500 hover:text-red-700">
                        ì—°ê²° ëŠê³  ì•± ì¬ì‹œì‘
                    </button>
                </div>
            `;
            // Attach stream to local video element immediately
            const localVideo = document.getElementById('local-video');
            if (localVideo && myStream) {
                localVideo.srcObject = myStream;
                updateStatus(`Host ID: ${myId} ìƒì„±ë¨. ìƒëŒ€ë°©ì˜ ì—°ê²°ì„ ê¸°ë‹¤ë¦¬ì„¸ìš”.`, 'success');
            } else {
                 updateStatus(`ì›¹ìº /ë§ˆì´í¬ ìŠ¤íŠ¸ë¦¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (ID: ${myId})`, 'warning');
            }
        }

        function renderClientConnectView() {
            contentDiv.innerHTML = `
                <div class="space-y-6">
                    <h2 class="text-2xl font-bold text-gray-800 text-center">3ë‹¨ê³„ ì¤€ë¹„: Host ì—°ê²°</h2>
                    <p class="text-gray-700 text-center">Hostì—ê²Œ ë°›ì€ IDë¥¼ ì•„ë˜ì— ì…ë ¥í•˜ê³  ì—°ê²° ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”.</p>

                    <div class="flex flex-col md:flex-row gap-4">
                        <input type="text" id="remote-id-input" placeholder="Host ID ì…ë ¥ (ì˜ˆ: unique-peer-id)"
                            class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-gray-700">
                        <button onclick="connectToHost()"
                            class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg shadow-md transition duration-150">
                            <span id="connect-btn-text">ì—°ê²° ì‹œë„</span>
                        </button>
                    </div>

                    <button onclick="setCurrentView('start')" class="mt-4 text-sm text-gray-500 hover:text-gray-700 block mx-auto">
                        &larr; ëŒì•„ê°€ê¸°
                    </button>
                </div>
            `;
            updateStatus("ì—°ê²°í•  Host IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.", 'info');
        }

        function renderChatView() {
            contentDiv.innerHTML = `
                <div class="text-center space-y-4">
                    <h2 class="text-2xl font-bold text-green-600">ğŸ‰ ì—°ê²° ì„±ê³µ! ì‹¤ì‹œê°„ í™”ìƒ í†µí™” ì¤‘</h2>

                    <div id="video-streams" class="video-container mt-4 rounded-xl overflow-hidden shadow-2xl">
                        <video id="local-video" autoplay muted playsinline class="rounded-lg shadow-inner" poster="https://placehold.co/600x400/374151/ffffff?text=ë‚´+ì˜ìƒ"></video>
                        <video id="remote-video" autoplay playsinline class="rounded-lg shadow-inner" poster="https://placehold.co/600x400/374151/ffffff?text=ìƒëŒ€ë°©+ì˜ìƒ"></video>
                    </div>
                    
                    <!-- Media Controls -->
                    <div class="flex justify-center gap-4 mt-4">
                        <button id="toggle-video-btn" onclick="toggleVideo()" title="ë¹„ë””ì˜¤ ë„ê¸°" class="p-3 rounded-full bg-green-500 hover:bg-green-600 text-white transition duration-150 shadow-lg">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-video"><path d="m22 8-6 4 6 4V8Z"/><path d="M14 5H4a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2Z"/></svg>
                        </button>
                        <button id="toggle-audio-btn" onclick="toggleAudio()" title="ë§ˆì´í¬ ë„ê¸°" class="p-3 rounded-full bg-green-500 hover:bg-green-600 text-white transition duration-150 shadow-lg">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-mic"><path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" x2="12" y1="19" y2="22"/></svg>
                        </button>
                    </div>

                    <!-- File Transfer Section -->
                    <div class="mt-8 p-4 border rounded-lg bg-gray-50 shadow">
                        <h3 class="text-xl font-semibold mb-3 text-gray-800">íŒŒì¼ ê³µìœ  (ìµœëŒ€ 100MB)</h3>
                        <input type="file" id="file-input" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                        <button onclick="sendFile()" id="send-file-btn" disabled class="mt-3 w-full bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 rounded-lg transition duration-150 disabled:opacity-50">
                            íŒŒì¼ ë³´ë‚´ê¸°
                        </button>
                        <p id="file-transfer-status" class="mt-2 text-sm text-blue-600 text-left hidden"></p>
                        
                        <!-- Receive Status Area -->
                        <div id="file-receive-area" class="mt-4 p-2 bg-white border border-dashed rounded-lg hidden text-left">
                            <p class="font-medium text-gray-700">ìˆ˜ì‹  íŒŒì¼ ìƒíƒœ:</p>
                            <p id="receive-status" class="text-sm text-gray-600"></p>
                        </div>
                    </div>


                    <p class="text-sm text-gray-500 mt-6">
                        Local ID: ${myId || 'N/A'} | Remote ID: ${remoteId || 'N/A'}
                    </p>

                    <button onclick="resetApp()" class="mt-8 text-sm bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-150">
                        í†µí™” ì¢…ë£Œ
                    </button>
                </div>
            `;
            
            // Attach streams to video elements
            const localVideo = document.getElementById('local-video');
            const remoteVideo = document.getElementById('remote-video');

            if (localVideo && myStream) localVideo.srcObject = myStream;
            if (remoteVideo && remoteStream) remoteVideo.srcObject = remoteStream;

            // Initial button states
            if (myStream) {
                // Initialize isVideoEnabled/isAudioEnabled based on current stream state (which should be true initially)
                const videoTrack = myStream.getVideoTracks()[0];
                const audioTrack = myStream.getAudioTracks()[0];
                isVideoEnabled = videoTrack ? videoTrack.enabled : false;
                isAudioEnabled = audioTrack ? audioTrack.enabled : false;
            }
            // Manually call toggle functions to set correct icons/colors based on initial state
            // If they are true, calling toggle with the opposite state will set them correctly.
            if (!isVideoEnabled) toggleVideo();
            if (!isAudioEnabled) toggleAudio();


            // Add listener for file input to enable send button
            document.getElementById('file-input').addEventListener('change', (e) => {
                const file = e.target.files[0];
                const sendBtn = document.getElementById('send-file-btn');
                const statusText = document.getElementById('file-transfer-status');

                if (file) {
                    if (file.size <= 100 * 1048576 && dataConnection && dataConnection.open) { // 100MB
                        sendBtn.disabled = false;
                        statusText.classList.add('hidden');
                    } else {
                        sendBtn.disabled = true;
                        if (file.size > 100 * 1048576) {
                            statusText.textContent = `íŒŒì¼ í¬ê¸°ê°€ 100MBë¥¼ ì´ˆê³¼í•©ë‹ˆë‹¤. (í˜„ì¬: ${(file.size / 1048576).toFixed(2)}MB)`;
                            statusText.classList.remove('hidden');
                            statusText.classList.add('text-red-600');
                        } else if (!dataConnection || !dataConnection.open) {
                            statusText.textContent = "ë°ì´í„° ì±„ë„ ì—°ê²° ëŒ€ê¸° ì¤‘... íŒŒì¼ì„ ë³´ë‚¼ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
                            statusText.classList.remove('hidden');
                            statusText.classList.add('text-yellow-600');
                        }
                    }
                } else {
                    sendBtn.disabled = true;
                    statusText.classList.add('hidden');
                }
            });

            updateStatus("í†µì‹ ì´ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤. ë§ˆì´í¬/ë¹„ë””ì˜¤ ë° íŒŒì¼ ê³µìœ ë¥¼ í™•ì¸í•˜ì„¸ìš”.", 'success');
        }

        // --- Core Application Logic ---

        function copyId(id) {
            // navigator.clipboard.writeText ëŒ€ì‹  document.execCommand('copy')ë¥¼ ì‚¬ìš©
            // iframe í™˜ê²½ì—ì„œ í´ë¦½ë³´ë“œ ì ‘ê·¼ ì œí•œ ì˜¤ë¥˜ë¥¼ ìš°íšŒí•˜ê¸° ìœ„í•¨
            try {
                const tempInput = document.createElement('input');
                tempInput.value = id;
                document.body.appendChild(tempInput);
                tempInput.select();
                
                // execCommandë¥¼ ì‚¬ìš©í•˜ì—¬ ë³µì‚¬ ì‹œë„
                const successful = document.execCommand('copy');
                document.body.removeChild(tempInput);

                if (successful) {
                    updateStatus("IDê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.", 'success');
                } else {
                    // execCommandê°€ ì‹¤íŒ¨í•  ê²½ìš° (ë§¤ìš° ë“œë¬¾)
                    console.error('Copy failed using execCommand.');
                    showModal("ë³µì‚¬ ì‹¤íŒ¨", "í´ë¦½ë³´ë“œ ì ‘ê·¼ì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. IDë¥¼ ì§ì ‘ ë³µì‚¬í•˜ì„¸ìš”.", false);
                }
            } catch (err) {
                // ì˜ˆì™¸ ì²˜ë¦¬ (execCommandê°€ ì§€ì›ë˜ì§€ ì•Šê±°ë‚˜ ì™„ì „íˆ ë¹„í™œì„±í™”ëœ ê²½ìš°)
                console.error('Copy failed using execCommand fallback:', err);
                showModal("ë³µì‚¬ ì‹¤íŒ¨", "í´ë¦½ë³´ë“œ ì ‘ê·¼ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. IDë¥¼ ì§ì ‘ ë³µì‚¬í•˜ì„¸ìš”.", false);
            }
        }

        function setCurrentView(view) {
            currentView = view;
            render();
        }

        function resetApp() {
            if (peer) {
                peer.destroy();
                peer = null;
            }
            if (myStream) {
                myStream.getTracks().forEach(track => track.stop());
                myStream = null;
            }
            myId = null;
            remoteId = null;
            remoteStream = null;
            dataConnection = null;
            receivingFile = {};
            isVideoEnabled = true;
            isAudioEnabled = true;
            setCurrentView('start');
            updateStatus("ì•±ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.", 'info');
        }

        async function getMedia() {
            try {
                // Get video and audio stream
                myStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                return myStream;
            } catch (err) {
                console.error("Failed to get local stream:", err);
                showModal("ë¯¸ë””ì–´ ì ‘ê·¼ ì˜¤ë¥˜", "ì›¹ìº ê³¼ ë§ˆì´í¬ ì ‘ê·¼ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”. (ì˜¤ë¥˜: " + err.name + ")", true);
                return null;
            }
        }

        // --- Host/Client PeerJS Handlers ---

        function setupPeerEvents() {
            peer.on('open', (id) => {
                myId = id;
                // Host flow: Move to display ID after successful Peer opening
                if (currentView === 'host_display') {
                    render(); // Re-render to show generated ID and video
                }
                updateStatus(`Peer ID ìƒì„± ì™„ë£Œ: ${myId}`, 'success');
            });

            // Host: Listen for incoming MediaConnection (Call)
            peer.on('call', (call) => {
                updateStatus(`Host: ${call.peer}ë¡œë¶€í„° ì˜ìƒ í†µí™” ìˆ˜ì‹  ì¤‘...`, 'warning');
                // Answer the incoming call and send our stream
                call.answer(myStream);
                handleCall(call);
            });
            
            // Host: Listen for incoming DataConnection (File/Data)
            peer.on('connection', (conn) => {
                updateStatus(`Host: ${conn.peer}ë¡œë¶€í„° ë°ì´í„° ì—°ê²° ìˆ˜ì‹  ì¤‘...`, 'warning');
                setupDataConnectionEvents(conn);
            });


            peer.on('error', (err) => {
                console.error("PeerJS Error:", err);
                showModal("PeerJS ì˜¤ë¥˜", "PeerJS ì—°ê²°ì— ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + err.message, true);
                resetApp();
            });

            peer.on('disconnected', () => {
                updateStatus("PeerJS ì„œë²„ì™€ ì—°ê²°ì´ ëŠê²¼ìŠµë‹ˆë‹¤. ì¬ì—°ê²°ì„ ì‹œë„í•©ë‹ˆë‹¤...", 'warning');
                // The PeerJS library often handles automatic reconnection, but good to log.
            });
        }

        function handleCall(call) {
            remoteId = call.peer; // Store remote ID
            
            call.on('stream', (stream) => {
                remoteStream = stream;
                // Only switch to chat view if data channel is also established, or if we are the host and the client initiated both.
                // For simplicity, switch to chat view as soon as the video connection is established.
                setCurrentView('chat'); 
            });

            call.on('close', () => {
                updateStatus("ìƒëŒ€ë°©ì´ ì—°ê²°ì„ ëŠì—ˆìŠµë‹ˆë‹¤.", 'info');
                resetApp();
            });
            
            call.on('error', (err) => {
                 console.error("Call Error:", err);
                 showModal("í†µí™” ì˜¤ë¥˜", "í™”ìƒ í†µí™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + err.message, true);
            });
        }


        async function startHostFlow() {
            const mediaStream = await getMedia();
            if (!mediaStream) return;

            setCurrentView('host_display');
            updateStatus("Host ID ìƒì„± ì¤‘...", 'info');

            // Initialize PeerJS without specifying an ID (let PeerJS generate one)
            peer = new Peer(undefined, peerConfig);
            setupPeerEvents();
        }

        async function connectToHost() {
            const remoteIdInput = document.getElementById('remote-id-input');
            const targetId = remoteIdInput.value.trim();

            if (!targetId) {
                updateStatus("ì—°ê²°í•  Host IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.", 'error');
                return;
            }

            remoteId = targetId;

            const mediaStream = await getMedia();
            if (!mediaStream) return;

            // Display loading state
            document.getElementById('connect-btn-text').textContent = "ì—°ê²° ì¤‘...";
            updateStatus(`Host ID (${targetId})ì— ì—°ê²° ì¤‘...`, 'warning');

            // Initialize PeerJS with a generated ID
            peer = new Peer(undefined, peerConfig);
            setupPeerEvents();

            peer.on('open', (id) => {
                myId = id;
                
                // 1. Initiate the DataConnection (for file sharing)
                const conn = peer.connect(targetId);
                setupDataConnectionEvents(conn); // Set up connection events immediately

                // 2. Initiate the MediaConnection (Call)
                const call = peer.call(targetId, myStream);
                if (call) {
                    updateStatus(`ì „í™” ê±¸ê¸° ì„±ê³µ. Hostê°€ ì‘ë‹µí•˜ê¸°ë¥¼ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘...`, 'warning');
                    handleCall(call);
                } else {
                    updateStatus(`ì˜¤ë¥˜: ID ${targetId}ì— ëŒ€í•œ ì—°ê²°ì„ ì‹œì‘í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`, 'error');
                    resetApp();
                }
            });
        }

        // --- Initialization ---
        window.onload = function() {
            render();
        }
    </script>
</body>
</html>